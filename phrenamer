#!/bin/sh
# See LICENSE file for copyright and license details.

die() {
	echo "$1" >&2
	exit 1
}

usage() {
	die 'usage: phrenamer [-d] [dir]'
}

while getopts :d opt; do
	case "$opt" in
	d)	dry='t' ;;
	?)	usage ;;
	esac
done

shift $((OPTIND - 1))
dir="${1:-$(pwd)}"

files=$(find "$dir" -regextype posix-extended -regex '.*\.(jpg|JPG|jpeg)' \
        | sort)
! [ "$files" ] && die 'Error: no files to rename.'

filenum=$(echo "$files" | wc -l)
zeroes=$((${#filenum} - 1)) # minus '\0'

IFS="
"
count=0
for fname in $files; do
	count=$((count + 1))
	newname=$(printf %s/%0${zeroes}d.jpg "${fname%/*}" "$count")
	echo "$fname -> $newname"
	! [ -f "$newname" ] && [ -z "$dry" ] && mv "$fname" "$newname"
done

